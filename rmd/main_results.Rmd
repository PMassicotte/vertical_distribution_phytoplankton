---
title: "Vertical distribution of the phytoplankton in the water column in the Baffin Bay"
description: |
  Presentation of the main results.
author:
  - name: Philippe Massicotte
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
    toc_float: true
    theme: theme.css
bibliography: /home/filoche/Documents/library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.pos = "center",
  cache = TRUE
)

library(here)
library(pdftools)
library(data.table)
library(tidyverse)
library(furrr)

plan(multiprocess(workers = availableCores() - 1))
```

```{r convert-pdf-to-png, cache=FALSE}

# Only convert PDF files that have been modified since the last compilation.

files <- fs::dir_ls(here("graphs"), glob = "*.pdf")

pdf_list <- here("graphs", "png", "pdf_list.RData")

if (!fs::file_exists(pdf_list)) {
  p <- tibble(name = NA, value = NA)
  save(p, file = pdf_list)
} else {
  load(pdf_list)
}

files <- tools::md5sum(fs::dir_ls(here("graphs"), glob = "*.pdf")) %>% 
  enframe() %>% 
  setdiff(p) %>% 
  pull(name)

future_walk(files, function(file) {
  
  # File path where the png file will be created
  png_file <- fs::path_ext_set(file, "png") %>% 
    fs::path_file() %>% 
    fs::path(here(), "graphs", "png", .)
    
  pdf_convert(
    file,
    filenames = png_file,
    format = "png",
    dpi = 200,
    verbose = FALSE,
    antialias = TRUE
  )
})

p <- tools::md5sum(fs::dir_ls(here("graphs"), glob = "*.pdf")) %>% 
  enframe()

save(p, file = pdf_list)

```

# Context

This project aims at exploring how various metrics/proxies can give insights on the vertical distribution of the phytoplankton biomass in the water column using the data measured during the Green Edge oceanographic cruise conducted in the Baffin Bay in 2016. *Four main indicators were considered to get insights about the phytoplankton biomass in the water column:*

1.  Fluorescence
2.  Pigments
3.  Particle beam attenuation coefficient (CP)
4.  Particle backscattering coefficient (bbp)

Most of the data is presented as a function of open water days (OWD) that were calculated in @Randelhoff2019. The first graph shows the OWD of each station.

```{r}
knitr::include_graphics(here("graphs/png/02_map_owd.png"))
```

# A note on the CTD data

After exploring the CTD data, I found out that there were some unwanted peaks in both the florescence and transmittance data. Therefore, I have used a median moving window to smooth the data (both transmittance and fluorescence).

```{r}
knitr::include_graphics(here("graphs/png/01_ctd_transmittance_with_peaks.png"))
```

# Data processing for 3D plots

During the meeting we had on 2021-01-22, it was questioned why I was averaging data by `owd` and `depth` before doing the interpolation. This is simply because it is possible that there are many observations for a specific pair of `owd` and `depth`. For example, it can be seen here that there are 9 values (i.e. 9 stations) that have an `owd = 2` and `depth = 1.980`.

```{r count-duplicated-owd-depth, cache=TRUE}
ctd <- fread(here::here("data/clean/ctd.csv"))

ctd[, .N, by = .(owd, depth_m)][N > 5] %>% 
  as_tibble() %>% 
  arrange(desc(N)) %>% 
  head(6) %>% 
  knitr::kable()
```

Here are 9 stations in the CTD data with `owd = 2` and `depth = 1.980`.

```{r count-duplicated-owd-depth2, cache=TRUE}
ctd %>%
  as_tibble() %>%
  filter(owd == 2 & depth_m == 1.98) %>%
  select(station, depth_m, owd, flor_mg_m3) %>%
  rmarkdown::paged_table()
```

Hence, before performing the interpolation, data has to be averaged by OWD and depth.

# Fluorescence

This section shows the vertical distribution of phytoplankton based on fluorescence.

## Fluorescence from the CTD

```{r}
knitr::include_graphics(here("graphs/png/02_phytoplankton_biomass_ctd.png"))
```

Using boxplots can be one interesting alternative way to present the data. For example, I have divided the CTD fluorescence data presented in the above graphic into ice-free/ice-covered and above/below the 0.1 isolume.

```{r}
knitr::include_graphics(here("graphs/png/02_boxplot_ctd_fluorescence_isolume_owd.png"))
```

## Fluorescence from the MVP

*Note that because the MVP is measuring continually, there are no stations associated with each measurement. This is why that the MVP data is not presented as a function of OWD.*

```{r}
knitr::include_graphics(here("graphs/png/05_phytoplankton_biomass_mvp_fluo.png"))
```

# Pigments

These graphs were made using the pigments data from the rosette. Pigments were summed into two groups:

1. Photoprotection pigments
2. Accessory pigments

```{r}
knitr::include_graphics(here("graphs/png/04_phytoplankton_biomass_pigments.png"))
```

# Particle beam attenuation coefficient (CP)

> The increase of cp during the lighted portion of the day is usually explained by the accumulation of intracellular carbon concentration associated with photosynthetic processes [@Kheireddine2014].

## CP from the CTD

The CP visualization based on the CTD can be seen above. There is a clear relationship between fluorescence and CP as seen below.

```{r}
knitr::include_graphics(here("graphs/png/02_scatterplot_fluorescence_vs_cp.png"))
```

The next graph shows the same data but divided differently. The best relation can be seen for the observations below the 0.1 isolume and located in open water. *I think the bottom left panel is the most interesting where **we can see the L shape**.*

```{r}
knitr::include_graphics(here("graphs/png/02_scatterplot_fluorescence_vs_cp_isolume_depth.png"))
```

Finally, the same data by transect.

```{r}
knitr::include_graphics(here("graphs/png/02_scatterplot_fluorescence_vs_cp_by_transect.png"))
```

The next graphic shows CP vertical profiles for some of the deepest stations below 500 meters. Any ideas why there are almost always a bump in the data in the very last portion of the profiles?

```{r}
knitr::include_graphics(here("graphs/png/02_vertical_profiles_cp.png"))
```

## CP from the MVP

```{r}
knitr::include_graphics(here("graphs/png/05_phytoplankton_biomass_mvp_cp.png"))
```

The next graphs show the longitudinal variability of CP at the deepest locations within each transect. The left column shows how the MVP was moving in the water column whereas the right column shows how CP varied along the transect. For example, we can see that the MVP followed the 300 meters line at transect 100.

```{r}
knitr::include_graphics(here("graphs/png/05_deepest_cp_longitudinal_profil.png"))
```

# Particle backscattering coefficient (bbp)

## bbp from the hydroscat

These graphs show bbp at six different wavelengths measured by the hydroscat.

```{r}
knitr::include_graphics(here("graphs/png/03_phytoplankton_biomass_hydroscat.png"))
```

# Particulate organic carbon (POC)

```{r}
knitr::include_graphics(here("graphs/png/18_poc_vs_owd.png"))
```

# bbp vs chlorophyll-a fluorescence (Hydroscat)

The next graphs explore the relationships between bbp and chlorophyll-a fluorescence from the Hydroscat device.

```{r}
knitr::include_graphics(here("graphs/png/24_scatterplot_hydroscat_bbp_fluo_chla.png"))
```

Same data divided differently.

```{r}
knitr::include_graphics(here("graphs/png/24_scatterplot_hydroscat_bbp_fluo_chla_by_group.png"))
```

# Comparing bbp at two wavelengths (Hydroscat)

Scatterplot between bbp measured at 532 nm and 700 nm.

```{r}
knitr::include_graphics(here("graphs/png/24_scatterplot_hydroscat_bbp_532nm_vs_700nm.png"))
```

Same data presented differently.

```{r}
knitr::include_graphics(here("graphs/png/24_scatterplot_hydroscat_bbp_532nm_vs_700nm_by_group.png"))
```

# Phytoplankton absorption

Maybe we could use absorption information to get some additional insights.

## Vertical profiles

This graph shows the vertical profiles of phytoplankton absorption at 440 nm. It seems that open water stations have subsurface maximum more apparent than the profiles of the ice-covered stations.

```{r}
knitr::include_graphics(here("graphs/png/22_vertical_profiles_aphy.png"))
```

## Spectral profiles

By looking at the spectral profiles, we can also notice that there are indeed differences in the water column. 

```{r}
knitr::include_graphics(here("graphs/png/22_spectral_profiles_phyto_absorption_isolume_owd.png"))
```

Finally, I have averaged the spectral profiles in four categories. I think these can be seen as end-members spectra.

```{r}
knitr::include_graphics(here("graphs/png/22_spectral_profiles_phyto_absorption_averaged_isolume_owd.png"))
```

## Comparing blue vs red regions

With all the data.

```{r}
knitr::include_graphics(here("graphs/png/23_scatterplot_phytoplankton_specific_absorption_blue_red.png"))
```

By groups.

```{r}
knitr::include_graphics(here("graphs/png/23_scatterplot_phytoplankton_specific_absorption_blue_red_by_group.png"))
```

## blue/red ratio of specific absorption

We can see that there is a an increase of the ratio after owd = 0. I am not sure to understand why the ratio is also higher at depth when owd < 0. Is there a shift when the ice is melting?

```{r}
knitr::include_graphics(here("graphs/png/23_visualize_phytoplankton_specific_absorption_blue_red_ratio_owd.png"))
```

# POC vs CP

The next graphs show the relationships between POC and CP.

```{r}
knitr::include_graphics(here("graphs/png/25_scatterplot_poc_vs_cp.png"))
```

```{r}
knitr::include_graphics(here("graphs/png/25_scatterplot_poc_vs_cp_by_group.png"))
```

# bbp vs chla (Hydroscat)

Note that I have used chla fluorescence from the Hydroscat which is given as raw counts. If we decide to go further with this data, I guess we could convert it in actual biomass/stock quantities.

```{r}
knitr::include_graphics(here("graphs/png/24_bbp_fchla_by_wavelength_hydroscat.png"))
```

# bbp vs cp

> The ratio bbp(532)/cp(660) could be considered as a proxy of parti- cle size and composition, increasing when small or inorganic particles become relatively more abundant than large or organic particles [@Xing2014].

So, based on the next graphs, larger particles are more abundant at depth than at the surface. However, I do not really see trends in the data.

```{r}
knitr::include_graphics(here("graphs/png/26_bbp_cp_by_wavelength.png"))
```

# xxx

This index was calculated as follow:

$$
\frac{\log(\frac{\text{bbp}(532)}{\text{bbp}(700)})}{0.274}
$$

```{r}
knitr::include_graphics(here("graphs/png/27_index_marcel.png"))
```
